

--- FILE: .gitignore ---

# Ignore venv directories
venv/
.venv/
*/venv/
*/.venv/

.vscode/



--- FILE: config.json ---

{
  "name": "JPG QF = 10 b/w",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Ghosh/Bottle/Left/PoiseVideos_20251102171753/PoiseVideos_20251102171753",
  "OUTPUT_DIR": "output/final_results",
  "TEMP_DIR": "test_sample",
  "SAMPLE_SIZE": 20,
  "TOGGLE_SAMPLE_CREATOR": true,
  "TOGGLE_CONVEX_HULL": true,
  "TOGGLE_CONVEX_HULL_CROP": false,
  "TOGGLE_GRAYSCALE": true,
  "TOGGLE_DOWNSCALE": true,
  "JPEG_QUALITY": 10,
  "SCALE_FACTOR": 1,
  "PADDING": 60,
  "SAVE_DEBUG": false,
  "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
}

--- FILE: dump_project.py ---

# dump_project.py
# Creates project_dump.txt in the project root, containing all text files
# with a header line showing each file's path relative to the root.

import os
from pathlib import Path

# ---- Tweak these if you like ----
OUTPUT_FILENAME = "project_dump.txt"
MAX_FILE_SIZE_MB = 3  # skip very large files

IGNORE_DIRS = {
    ".git", ".hg", ".svn",
    "__pycache__", ".mypy_cache", ".pytest_cache",
    ".venv", "venv", "env",
    "node_modules", ".cache", ".parcel-cache", ".sass-cache",
    "build", "dist", ".next", ".turbo", "target", ".gradle",
    ".idea", ".vscode", ".terraform"
}

# Common binary/heavy extensions to skip
IGNORE_FILE_EXTS = {
    # compiled/binaries
    ".pyc", ".pyo", ".class", ".o", ".obj", ".a", ".lib",
    ".so", ".dylib", ".dll", ".exe",
    # archives
    ".zip", ".tar", ".gz", ".bz2", ".xz", ".7z", ".rar",
    # media
    ".png", ".jpg", ".jpeg", ".gif", ".bmp", ".ico", ".webp",
    ".mp3", ".wav", ".flac", ".ogg",
    ".mp4", ".mov", ".avi", ".mkv", ".webm",
    # fonts
    ".ttf", ".otf", ".eot", ".woff", ".woff2",
    # dbs and others
    ".db", ".db3", ".sqlite", ".sqlite3", ".pdf", ".bin", ".iso",
    ".log",
    #docs
    ".pdf", ".docx"
}

# Exact file names to skip (secrets/locks/dump itself)
IGNORE_FILE_NAMES = {
    OUTPUT_FILENAME,
    ".env", ".env.local", ".env.development", ".env.production",
    "Pipfile.lock", "poetry.lock", "package-lock.json", "yarn.lock", "pnpm-lock.yaml",
    "Thumbs.db", ".DS_Store"
}


def should_skip_file(path: Path) -> bool:
    name = path.name
    if name in IGNORE_FILE_NAMES:
        return True
    if path.suffix.lower() in IGNORE_FILE_EXTS:
        return True
    try:
        if path.stat().st_size > MAX_FILE_SIZE_MB * 1024 * 1024:
            return True
    except OSError:
        return True  # if we can't stat, skip it
    return False


def main():
    root = Path(__file__).resolve().parent
    out_path = root / OUTPUT_FILENAME

    with out_path.open("w", encoding="utf-8") as out:
        for dirpath, dirnames, filenames in os.walk(root, topdown=True):
            # Prune ignored directories (by name)
            dirnames[:] = [d for d in dirnames if d not in IGNORE_DIRS]

            for fname in filenames:
                fpath = Path(dirpath) / fname
                # Skip dump file and other ignored files
                if should_skip_file(fpath):
                    continue

                rel = fpath.relative_to(root).as_posix()
                out.write(f"\n\n--- FILE: {rel} ---\n\n")

                # Best-effort read in text
                try:
                    with fpath.open("r", encoding="utf-8") as f:
                        out.write(f.read())
                except UnicodeDecodeError:
                    try:
                        with fpath.open("r", encoding="latin-1") as f:
                            out.write(f.read())
                    except Exception as e:
                        out.write(f"[Could not read file: {e}]\n")
                except Exception as e:
                    out.write(f"[Could not read file: {e}]\n")

    print(f"‚úÖ Dump complete ‚Üí {out_path}")


if __name__ == "__main__":
    main()


--- FILE: README.md ---

# üß© Image Processing Pipeline ‚Äì Beginner Guide

This project helps you process images with different steps like **format conversion, convex hull masking, grayscale, and downscaling**.
You can control everything using **toggles in a JSON config**.

The repo also has tools to **test many different configurations at once** and generate a **report with charts and images**.

---

## 1. üì¶ Setup Instructions

### Step 1: Clone the repo

```bash
git clone https://github.com/mukhokironmoy/NewroKaaya_Internship.git
cd your-repo
```

### Step 2: Create a virtual environment (Python 3.9)

```bash
py -3.9 -m venv .venv
# Linux/Mac
source .venv/bin/activate
# Windows (PowerShell)
.venv\Scripts\Activate
```

### Step 3: Install requirements

```bash
pip install -r requirements.txt
```

---

## 2. üìÇ Project Overview

Key scripts:

- **`run.py`** ‚Üí Runs the pipeline on one configuration (you edit JSON inside it or load an external one).
- **`test_pipeline_report.py`** ‚Üí Runs many test cases (from JSON files in `test_cases/`) and generates reports.
- Helper scripts:

  - `sample_creator.py` ‚Üí picks a random sample of images
  - `convert_format.py` ‚Üí changes image format (JPG/WEBP)
  - `convex_hull.py` ‚Üí applies background mask
  - `grayscale.py` ‚Üí turns images grayscale
  - `downquality_and_downscale.py` ‚Üí resizes / adjusts quality

Outputs:

- `output/final_results/` ‚Üí results from your last run
- `test_cases/<TEST_NAME>/<timestamp>/` ‚Üí results & reports from batch testing

---

## 3. ‚ñ∂Ô∏è Running the Pipeline with `run.py`

There are **two ways to set config in run.py**:

---

### **Option A: Edit Inline JSON (easiest to start with)**

Inside `run.py`, you‚Äôll see:

```python
CONFIG_JSON = """
{
  "name": "WebP Grayscale",
  "SAMPLE_INPUT_DIR": "C:/path/to/your/images",
  "SAMPLE_SIZE": 50,
  "TOGGLE_SAMPLE_CREATOR": true,
  "TOGGLE_CONVERT_FORMAT": true,
  "TOGGLE_CONVEX_HULL": true,
  "TOGGLE_CONVEX_HULL_CROP": false,
  "TOGGLE_GRAYSCALE": true,
  "TOGGLE_DOWNSCALE": false,
  "OUTPUT_FORMAT": "webp",
  "JPEG_QUALITY": 100,
  "WEBP_QUALITY": 100,
  "SCALE_FACTOR": 1,
  "PADDING": 60,
  "SAVE_DEBUG": false
}
"""
```

üëâ **What to change here:**

- `SAMPLE_INPUT_DIR`: Path to your input folder of images.

  - Example Windows: `"C:/Users/you/Pictures/my_dataset"`
  - Example Linux/Mac: `"/home/you/Pictures/my_dataset"`

- `SAMPLE_SIZE`: Number of random images to use if `TOGGLE_SAMPLE_CREATOR = true`.

üëâ **How to run:**

```bash
python run.py
```

Results go to `output/final_results/`.

---

### **Option B: Use an External JSON Config**

1. Create a new file, e.g. `config.json`, with the same structure as above.
2. In `run.py`, comment out **Option A** and uncomment Option B:

   ```python
   # CONFIG_PATH = Path("config.json")
   # with open(CONFIG_PATH, "r", encoding="utf-8") as f:
   #     CONFIG = json.load(f)
   ```

3. Now run:

   ```bash
   python run.py
   ```

---

## 4. üß™ Running Batch Tests with `test_pipeline_report.py`

If you want to try **many configs automatically**:

1. Look inside `test_cases/`.

   - Example: `combination_of_controls.json`, `Individual_controls_testing.json`
   - Each file is just a list of JSON objects (multiple configs).

2. In `test_pipeline_report.py`, edit these two lines:

   ```python
   TEST_NAME = "Individual_controls_testing"
   TEST_JSON_PATH = r"test_cases\combination_of_controls.json"
   ```

üëâ **What to change here:**

- `TEST_NAME`: Just a label for the output folder.
- `TEST_JSON_PATH`: Path to your test JSON file (choose one from `test_cases/` or create your own).

3. Run:

   ```bash
   python test_pipeline_report.py
   ```

üëâ Outputs will appear in:

```
test_cases/<TEST_NAME>/<timestamp>/
```

Includes:

- `compression_report.csv` ‚Üí table with file sizes & compression
- `sizes_comparison.png` ‚Üí bar chart (before vs after)
- `compression_percent.png` ‚Üí line chart (compression %)
- `compression_report.pdf` ‚Üí summary table + graphs + case-by-case images

---

## 5. üîÄ Explanation of Toggles

Each config JSON can toggle stages on/off:

| Key                       | What it does                            |
| ------------------------- | --------------------------------------- |
| `TOGGLE_SAMPLE_CREATOR`   | Copy random sample into `test_sample/`  |
| `TOGGLE_CONVERT_FORMAT`   | Convert to `OUTPUT_FORMAT` with quality |
| `TOGGLE_CONVEX_HULL`      | Apply background removal mask           |
| `TOGGLE_CONVEX_HULL_CROP` | Crop tightly to mask                    |
| `TOGGLE_GRAYSCALE`        | Convert to grayscale                    |
| `TOGGLE_DOWNSCALE`        | Downscale by `SCALE_FACTOR`             |
| `SAVE_DEBUG`              | Save debug images with landmarks/hull   |

Other parameters:

- `OUTPUT_FORMAT`: `"jpg"`, `"webp"`, `"png"`, etc.
- `JPEG_QUALITY`, `WEBP_QUALITY`: 0‚Äì100 quality factors
- `SCALE_FACTOR`: e.g. `0.75` ‚Üí shrink to 75%
- `PADDING`: Extra pixels around hull mask

---

## 6. üñº Example Walkthroughs

### Example 1: Single run with grayscale

- Edit `run.py` ‚Üí set `SAMPLE_INPUT_DIR` to your dataset
- Set `"TOGGLE_GRAYSCALE": true`
- Run `python run.py`
- Output in `output/final_results/`

### Example 2: Run predefined batch

- Open `test_pipeline_report.py`
- Point to `test_cases/combination_of_controls.json`
- Run `python test_pipeline_report.py`
- Check `test_cases/combination_of_controls/<timestamp>/compression_report.pdf`

### Example 3: Make your own test JSON

- Copy `test_cases/combination_of_controls.json` ‚Üí `test_cases/my_experiments.json`
- Edit toggles/parameters
- Point `TEST_JSON_PATH` to your file
- Run the test report script

---


--- FILE: requirements.txt ---

matplotlib
numpy
mediapipe
opencv-python
pandas
pytest

--- FILE: run.py ---

"""
Unified JPG-only image processing pipeline (Final Version ‚Äî Black Background)
------------------------------------------------------------------------------
Loads configuration from JSON and applies:
  1. Optional sample creation
  2. Convex hull masking (with optional cropping)
  3. Optional grayscale conversion
  4. Optional downscaling
All input and output are strictly .jpg.
This version:
  ‚úÖ Fixes color inversion
  ‚úÖ Maintains black background outside hull
  ‚úÖ Handles grayscale + MozJPEG properly
"""

import cv2, json, shutil, random, subprocess
import numpy as np
from pathlib import Path
from PIL import Image
import mediapipe as mp

# ==========================
# Load Configuration
# ==========================
CONFIG_PATH = Path("config.json")
with open(CONFIG_PATH, "r", encoding="utf-8") as f:
    CFG = json.load(f)

# Convert to Path objects
CFG["INPUT_DIR"] = Path(CFG["INPUT_DIR"])
CFG["OUTPUT_DIR"] = Path(CFG.get("OUTPUT_DIR", "output/final_results"))
CFG["TEMP_DIR"] = Path(CFG.get("TEMP_DIR", "test_sample"))

# Ensure directories exist
for key in ["INPUT_DIR", "OUTPUT_DIR", "TEMP_DIR"]:
    CFG[key].mkdir(parents=True, exist_ok=True)

# ==========================
# Global Controls
# ==========================
TOGGLE_SAMPLE_CREATOR = CFG.get("TOGGLE_SAMPLE_CREATOR", True)
TOGGLE_CONVEX_HULL = CFG.get("TOGGLE_CONVEX_HULL", True)
TOGGLE_CONVEX_HULL_CROP = CFG.get("TOGGLE_CONVEX_HULL_CROP", False)
TOGGLE_GRAYSCALE = CFG.get("TOGGLE_GRAYSCALE", True)
TOGGLE_DOWNSCALE = CFG.get("TOGGLE_DOWNSCALE", False)

SAMPLE_SIZE = CFG.get("SAMPLE_SIZE", 50)
JPEG_QUALITY = CFG.get("JPEG_QUALITY", 80)
SCALE_FACTOR = CFG.get("SCALE_FACTOR", 1.0)
PADDING = CFG.get("PADDING", 60)
SAVE_DEBUG = CFG.get("SAVE_DEBUG", False)

# Mediapipe setup
mp_pose = mp.solutions.pose
pose = mp_pose.Pose(static_image_mode=True, model_complexity=2)
mp_drawing = mp.solutions.drawing_utils

# ==========================
# Utility functions
# ==========================
def clean_dir(path: Path):
    """Remove and recreate directory."""
    if path.exists():
        shutil.rmtree(path)
    path.mkdir(parents=True, exist_ok=True)


def save_jpg(image: np.ndarray, path: Path):
    """
    Save image as JPG using MozJPEG for better compression.
    Accepts BGR or grayscale; outputs correct color with black background.
    """
    CJPEG_PATH = Path(CFG.get("MOZJPEG_PATH", "cjpeg.exe"))
    path.parent.mkdir(parents=True, exist_ok=True)

    temp_png = path.with_name(path.stem + "_temp.png")

    # Write temporary PNG
    if len(image.shape) == 2:  # grayscale
        cv2.imwrite(str(temp_png), image)
    else:  # BGR color
        cv2.imwrite(str(temp_png), image)

    # Try MozJPEG first
    if CJPEG_PATH.exists():
        try:
            subprocess.run([
                str(CJPEG_PATH),
                "-quality", str(JPEG_QUALITY),
                "-progressive",
                "-optimize",
                "-outfile", str(path),
                str(temp_png)
            ], check=True)
            print(f"‚úÖ [MozJPEG] Saved {path.name} (Q={JPEG_QUALITY})")
        except Exception as e:
            print(f"‚ö†Ô∏è MozJPEG failed for {path.name}: {e}")
            _save_with_pillow(image, path)
    else:
        _save_with_pillow(image, path)

    if temp_png.exists():
        temp_png.unlink()


def _save_with_pillow(image: np.ndarray, path: Path):
    """Fallback save using Pillow if MozJPEG unavailable."""
    if len(image.shape) == 2:  # grayscale
        Image.fromarray(image).save(path, "JPEG", quality=JPEG_QUALITY, optimize=True)
    else:  # color image (BGR ‚Üí RGB)
        Image.fromarray(cv2.cvtColor(image, cv2.COLOR_BGR2RGB)).save(path, "JPEG", quality=JPEG_QUALITY, optimize=True)
    print("‚ö†Ô∏è Saved with Pillow fallback.")


def crop_to_mask(image: np.ndarray, mask: np.ndarray):
    """Crops the image tightly around the nonzero region of the mask."""
    ys, xs = np.where(mask > 0)
    if len(xs) == 0 or len(ys) == 0:
        return image
    return image[ys.min():ys.max(), xs.min():xs.max()]


# ==========================
# Stage 1 ‚Äî Sample Creation
# ==========================
def create_sample(input_dir: Path, output_dir: Path, sample_size: int):
    images = sorted([p for p in input_dir.glob("*.jpg")])
    if not images:
        raise ValueError(f"No .jpg files in {input_dir}")
    sample = random.sample(images, min(sample_size, len(images)))
    for img in sample:
        shutil.copy(img, output_dir / img.name)
    print(f"‚úÖ Copied {len(sample)} samples to {output_dir}")


# ==========================
# Stage 2 ‚Äî Convex Hull Mask
# ==========================
def apply_convex_hull(img: np.ndarray, crop=False):
    """
    Apply convex hull around detected pose landmarks.
    Keeps inside of hull, fills background with black.
    """
    h, w, _ = img.shape
    rgb_for_pose = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    results = pose.process(rgb_for_pose)

    if not results.pose_landmarks:
        return img

    # Extract pose points and convex hull
    points = np.array([[int(lm.x * w), int(lm.y * h)] for lm in results.pose_landmarks.landmark])
    hull = cv2.convexHull(points)

    # Create binary mask and apply padding
    mask = np.zeros((h, w), np.uint8)
    cv2.fillConvexPoly(mask, hull, 255)
    mask = cv2.dilate(mask, np.ones((PADDING, PADDING), np.uint8), iterations=1)

    # Black background instead of white
    result = np.zeros_like(img)
    result[mask == 255] = img[mask == 255]

    if crop:
        result = crop_to_mask(result, mask)

    return result  # stays BGR


# ==========================
# Stage 3 ‚Äî Grayscale
# ==========================
def to_grayscale(img: np.ndarray):
    """Convert color (BGR) image to grayscale."""
    return cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)


# ==========================
# Stage 4 ‚Äî Downscale
# ==========================
def downscale(img: np.ndarray, factor: float):
    """Resize image by given factor."""
    h, w = img.shape[:2]
    new_size = (int(w * factor), int(h * factor))
    return cv2.resize(img, new_size, interpolation=cv2.INTER_AREA)


# ==========================
# Main Pipeline
# ==========================
def pipeline():
    clean_dir(CFG["OUTPUT_DIR"])
    if TOGGLE_SAMPLE_CREATOR:
        clean_dir(CFG["TEMP_DIR"])
        create_sample(CFG["INPUT_DIR"], CFG["TEMP_DIR"], SAMPLE_SIZE)
        source = CFG["TEMP_DIR"]
    else:
        source = CFG["INPUT_DIR"]

    files = list(source.glob("*.jpg"))
    if not files:
        print("‚ö†Ô∏è No input JPG files found.")
        return

    for f in files:
        img = cv2.imread(str(f))
        if img is None:
            print(f"‚ö†Ô∏è Could not read {f.name}")
            continue

        # 1Ô∏è‚É£ Convex Hull
        if TOGGLE_CONVEX_HULL:
            img = apply_convex_hull(img, crop=TOGGLE_CONVEX_HULL_CROP)

        # 2Ô∏è‚É£ Grayscale
        if TOGGLE_GRAYSCALE:
            img = to_grayscale(img)

        # 3Ô∏è‚É£ Downscale
        if TOGGLE_DOWNSCALE and SCALE_FACTOR < 1:
            img = downscale(img, SCALE_FACTOR)

        # 4Ô∏è‚É£ Save result
        out_path = CFG["OUTPUT_DIR"] / f.name
        save_jpg(img, out_path)
        print(f"‚úÖ Saved {out_path.name}")

    print("üéâ Processing complete!")


# ==========================
# Run
# ==========================
if __name__ == "__main__":
    print(f"üöÄ Running unified JPG pipeline: {CFG.get('name', 'Unnamed run')}")
    pipeline()


--- FILE: test_pipeline_run.py ---

"""
MozJPEG-Integrated Test Pipeline (Fixed Version)
------------------------------------------------
Runs multiple configurations from a JSON file using the updated run.py pipeline
that supports MozJPEG compression and sample creation.
Generates CSV, PNG graphs, and a PDF report comparing compression performance.
Now correctly handles grayscale visualization in Matplotlib (no false color).
"""

import json, shutil, subprocess, sys, textwrap
from pathlib import Path
from datetime import datetime
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages
from PIL import Image

# ======================
# Config
# ======================
TEST_NAME = "mozjpeg_combination_test"
TEST_JSON_PATH = Path("test_cases\dataset_comparison.json")
PIPELINE_SCRIPT = "run.py"

# Default MozJPEG path (update if needed)
MOZJPEG_PATH = r"C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"

# ======================
# Helpers
# ======================
def get_folder_size(path: Path) -> int:
    """Returns total folder size in bytes."""
    return sum(f.stat().st_size for f in path.glob("**/*") if f.is_file())

# ======================
# Main test runner
# ======================
def run_experiments():
    with open(TEST_JSON_PATH, "r", encoding="utf-8") as f:
        test_cases = json.load(f)

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    run_dir = Path("test_cases") / TEST_NAME / timestamp
    run_dir.mkdir(parents=True, exist_ok=True)
    buffer_dir = run_dir / "buffers"
    buffer_dir.mkdir(parents=True, exist_ok=True)

    results = []

    for idx, case in enumerate(test_cases, start=1):
        print(f"\n=== Running test case {idx}: {case['name']} ===")

        # --- Ensure MozJPEG + Sample Creation are always enabled ---
        case["MOZJPEG_PATH"] = case.get("MOZJPEG_PATH", MOZJPEG_PATH)
        case["TOGGLE_SAMPLE_CREATOR"] = True

        # Write current case config
        with open("config.json", "w", encoding="utf-8") as f:
            json.dump(case, f, indent=2)

        # Run pipeline safely
        try:
            subprocess.run([sys.executable, PIPELINE_SCRIPT], check=True)
        except subprocess.CalledProcessError:
            print(f"‚ö†Ô∏è Pipeline failed for case {case['name']}")
            continue

        # Measure compression
        sample_dir = Path("test_sample")
        final_dir = Path("output/final_results")

        sample_size = get_folder_size(sample_dir)
        final_size = get_folder_size(final_dir)
        compression = 100 * (1 - final_size / sample_size) if sample_size > 0 else 0

        # Copy one sample + final example image for comparison
        sample_img = next(sample_dir.glob("*.jpg"), None)
        final_img = next(final_dir.glob("*.jpg"), None)
        if sample_img and final_img:
            case_buf_dir = buffer_dir / f"case_{idx}"
            case_buf_dir.mkdir(parents=True, exist_ok=True)
            shutil.copy(sample_img, case_buf_dir / "sample.jpg")
            shutil.copy(final_img, case_buf_dir / "final.jpg")

        # Collect results
        results.append({
            "Case": case["name"],
            "JPEG_Q": case.get("JPEG_QUALITY", 80),
            "Scale": case.get("SCALE_FACTOR", 1.0),
            "ConvexHull": case.get("TOGGLE_CONVEX_HULL", True),
            "Crop": case.get("TOGGLE_CONVEX_HULL_CROP", False),
            "Grayscale": case.get("TOGGLE_GRAYSCALE", True),
            "Downscale": case.get("TOGGLE_DOWNSCALE", False),
            "MozJPEG": Path(case["MOZJPEG_PATH"]).exists(),
            "SampleSizeKB": sample_size / 1024,
            "FinalSizeKB": final_size / 1024,
            "Compression%": compression,
        })

    df = pd.DataFrame(results)
    if not df.empty:
        df.to_csv(run_dir / "compression_report.csv", index=False)
        print(f"\n‚úÖ Results saved ‚Üí {run_dir/'compression_report.csv'}")
        generate_pdf_report(df, run_dir)
    else:
        print("‚ö†Ô∏è No successful test cases recorded.")
    return df

# ======================
# PDF report generator
# ======================
def generate_pdf_report(df: pd.DataFrame, run_dir: Path):
    df = df.copy()
    df["Case"] = df["Case"].apply(lambda x: "\n".join(textwrap.wrap(x, width=18)))

    # ---------- Charts ----------
    plt.figure(figsize=(10,6))
    bar_width = 0.35
    x = range(len(df))
    plt.bar([i - bar_width/2 for i in x], df["SampleSizeKB"], width=bar_width, label="Sample Total")
    plt.bar([i + bar_width/2 for i in x], df["FinalSizeKB"], width=bar_width, label="Final Total")
    plt.xticks(x, df["Case"], rotation=20, ha="right")
    plt.ylabel("Folder Size (KB)")
    plt.title("Total Size: Sample vs Final Result")
    plt.legend()
    plt.tight_layout()
    plt.savefig(run_dir / "sizes_comparison.png")

    plt.figure(figsize=(10,6))
    plt.plot(df["Case"], df["Compression%"], marker="o")
    plt.ylabel("Compression (%)")
    plt.title("Compression Achieved per Test Case")
    plt.xticks(rotation=20, ha="right")
    plt.tight_layout()
    plt.savefig(run_dir / "compression_percent.png")

    # ---------- PDF Generation ----------
    with PdfPages(run_dir / "compression_report.pdf") as pdf:
        # Table
        fig, ax = plt.subplots(figsize=(12,4))
        ax.axis("tight"); ax.axis("off")
        table = ax.table(cellText=df.round(2).values, colLabels=df.columns, loc="center")
        table.auto_set_font_size(False)
        table.set_fontsize(8)
        table.scale(1.2, 1.4)
        pdf.savefig(fig); plt.close(fig)

        # Charts
        for img_file in ["sizes_comparison.png", "compression_percent.png"]:
            img = plt.imread(run_dir / img_file)
            fig, ax = plt.subplots(figsize=(10,6))
            ax.imshow(img)
            ax.axis("off")
            ax.set_title(img_file.replace(".png", "").replace("_", " ").title())
            pdf.savefig(fig); plt.close(fig)

        # ---------- Case-by-case comparison ----------
        buffer_dir = run_dir / "buffers"
        for idx, row in df.iterrows():
            case_buf = buffer_dir / f"case_{idx+1}"
            sample = case_buf / "sample.jpg"
            final = case_buf / "final.jpg"
            if not sample.exists() or not final.exists():
                continue

            s_img = Image.open(sample)
            f_img = Image.open(final)
            s_res, f_res = s_img.size, f_img.size
            s_size, f_size = sample.stat().st_size / 1024, final.stat().st_size / 1024

            fig, axs = plt.subplots(1, 2, figsize=(12,6))
            for ax, im, name, res, size in [
                (axs[0], s_img, "Sample", s_res, s_size),
                (axs[1], f_img, "Final", f_res, f_size)
            ]:
                # ‚úÖ FIX: Display grayscale correctly (no false color)
                if im.mode == "L":
                    ax.imshow(im, cmap="gray", vmin=0, vmax=255)
                else:
                    ax.imshow(im)
                ax.axis("off")
                ax.set_title(f"{name}\n{res[0]}√ó{res[1]} | {size:.1f} KB")

            plt.suptitle(f"Case {idx+1}: {row['Case']}")
            pdf.savefig(fig)
            plt.close(fig)

    print(f"üìÑ PDF report saved ‚Üí {run_dir/'compression_report.pdf'}")

# ======================
# Entry point
# ======================
if __name__ == "__main__":
    df = run_experiments()
    print("\nüéâ Done! All reports generated successfully.")


--- FILE: test_cases/combination_of_controls.json ---

[
  {
    "name": "JPG QF = 10",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Shabari/Bottle/Left/PoiseVideos_20251102122759/PoiseVideos_20251102122759",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
  {
    "name": "JPG QF = 10 b/w",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Shabari/Bottle/Left/PoiseVideos_20251102122759/PoiseVideos_20251102122759",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": true,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  }
]


--- FILE: test_cases/dataset_comparison.json ---

[
  {
    "name": "JPG QF = 10",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Shabari/Bottle/Left/PoiseVideos_20251102122759/PoiseVideos_20251102122759",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
  {
    "name": "JPG QF = 10 b/w",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Shabari/Bottle/Left/PoiseVideos_20251102122759/PoiseVideos_20251102122759",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": true,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
    {
    "name": "JPG QF = 10",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Anvita/Bottle/Left/PoiseVideos_20251102081035/PoiseVideos_20251102081035",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
  {
    "name": "JPG QF = 10 b/w",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Anvita/Bottle/Left/PoiseVideos_20251102081035/PoiseVideos_20251102081035",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": true,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
      {
    "name": "JPG QF = 10",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Ghosh/Bottle/Left/PoiseVideos_20251102171753/PoiseVideos_20251102171753",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  },
  {
    "name": "JPG QF = 10 b/w",
  "INPUT_DIR": "C:/DATA/Internships/Newro Kaaya/Data/Data/Ghosh/Bottle/Left/PoiseVideos_20251102171753/PoiseVideos_20251102171753",
    "OUTPUT_DIR": "output/final_results",
    "TEMP_DIR": "test_sample",
    "SAMPLE_SIZE": 20,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": true,
    "TOGGLE_DOWNSCALE": true,
    "JPEG_QUALITY": 10,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false,
    "MOZJPEG_PATH": "C:/DATA/Internships/Newro Kaaya/Working_Build_v3/mozjpeg_4.1.1_x64/mozjpeg_4.1.1_x64/shared/tools/cjpeg.exe"
  }
]


--- FILE: test_cases/Individual_controls_testing.json ---

[
  {
    "name": "WebP default",
    "SAMPLE_INPUT_DIR": "C:/PoiseVideos/4825_Prasanna K.B_189_20250916173306/4825_Prasanna K.B_189_20250916173306",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVERT_FORMAT": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": false,
    "OUTPUT_FORMAT": "webp",
    "JPEG_QUALITY": 100,
    "WEBP_QUALITY": 100,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false
  },
  {
    "name": "WebP Crop",
    "SAMPLE_INPUT_DIR": "C:/PoiseVideos/4825_Prasanna K.B_189_20250916173306/4825_Prasanna K.B_189_20250916173306",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVERT_FORMAT": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": true,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "OUTPUT_FORMAT": "webp",
    "JPEG_QUALITY": 100,
    "WEBP_QUALITY": 100,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false
  },
  {
    "name": "WebP Grayscale",
    "SAMPLE_INPUT_DIR": "C:/PoiseVideos/4825_Prasanna K.B_189_20250916173306/4825_Prasanna K.B_189_20250916173306",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVERT_FORMAT": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": true,
    "TOGGLE_DOWNSCALE": false,
    "OUTPUT_FORMAT": "webp",
    "JPEG_QUALITY": 100,
    "WEBP_QUALITY": 100,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false
  },
  {
    "name": "WebP Quality factor",
    "SAMPLE_INPUT_DIR": "C:/PoiseVideos/4825_Prasanna K.B_189_20250916173306/4825_Prasanna K.B_189_20250916173306",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVERT_FORMAT": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "OUTPUT_FORMAT": "webp",
    "JPEG_QUALITY": 75,
    "WEBP_QUALITY": 75,
    "SCALE_FACTOR": 1,
    "PADDING": 60,
    "SAVE_DEBUG": false
  },
  {
    "name": "WebP Downscaling",
    "SAMPLE_INPUT_DIR": "C:/PoiseVideos/4825_Prasanna K.B_189_20250916173306/4825_Prasanna K.B_189_20250916173306",
    "SAMPLE_SIZE": 50,
    "TOGGLE_SAMPLE_CREATOR": true,
    "TOGGLE_CONVERT_FORMAT": true,
    "TOGGLE_CONVEX_HULL": true,
    "TOGGLE_CONVEX_HULL_CROP": false,
    "TOGGLE_GRAYSCALE": false,
    "TOGGLE_DOWNSCALE": true,
    "OUTPUT_FORMAT": "webp",
    "JPEG_QUALITY": 100,
    "WEBP_QUALITY": 100,
    "SCALE_FACTOR": 0.8,
    "PADDING": 60,
    "SAVE_DEBUG": false
  }
]


--- FILE: test_cases/mozjpeg_combination_test/20251026_191240/compression_report.csv ---

Case,JPEG_Q,Scale,ConvexHull,Crop,Grayscale,Downscale,MozJPEG,SampleSizeKB,FinalSizeKB,Compression%
JPG QF = 10,10,1,True,False,False,True,True,343.208984375,148.7001953125,56.67357147328465
JPG QF = 10 b/w,10,1,True,False,True,True,True,344.5224609375,119.0263671875,65.45178306702834


--- FILE: test_cases/mozjpeg_combination_test/20251102_184716/compression_report.csv ---

Case,JPEG_Q,Scale,ConvexHull,Crop,Grayscale,Downscale,MozJPEG,SampleSizeKB,FinalSizeKB,Compression%
JPG QF = 10,10,1,True,False,False,True,True,344.2392578125,148.09765625,56.97827807580688
JPG QF = 10 b/w,10,1,True,False,True,True,True,344.453125,117.849609375,65.78645951462917


--- FILE: test_cases/mozjpeg_combination_test/20251102_192155/compression_report.csv ---

Case,JPEG_Q,Scale,ConvexHull,Crop,Grayscale,Downscale,MozJPEG,SampleSizeKB,FinalSizeKB,Compression%
JPG QF = 10,10,1,True,False,False,True,True,343.5390625,148.623046875,56.73765719873558
JPG QF = 10 b/w,10,1,True,False,True,True,True,343.7578125,118.986328125,65.38658212313356


--- FILE: test_cases/mozjpeg_combination_test/20251102_194921/compression_report.csv ---

Case,JPEG_Q,Scale,ConvexHull,Crop,Grayscale,Downscale,MozJPEG,SampleSizeKB,FinalSizeKB,Compression%
JPG QF = 10,10,1,True,False,False,True,True,187.3759765625,79.111328125,57.779364475460326
JPG QF = 10 b/w,10,1,True,False,True,True,True,187.208984375,64.53515625,65.52774618939813
JPG QF = 10,10,1,True,False,False,True,True,146.8359375,52.6396484375,64.15070497472732
JPG QF = 10 b/w,10,1,True,False,True,True,True,146.712890625,40.9169921875,72.11084042227458
JPG QF = 10,10,1,True,False,False,True,True,163.517578125,60.38671875,63.07019744150213
JPG QF = 10 b/w,10,1,True,False,True,True,True,163.9169921875,48.107421875,70.65135149626752


--- FILE: test_cases/mozjpeg_combination_test/20251108_095059/compression_report.csv ---

Case,JPEG_Q,Scale,ConvexHull,Crop,Grayscale,Downscale,MozJPEG,SampleSizeKB,FinalSizeKB,Compression%
JPG QF = 10,10,1,True,False,False,True,True,187.4130859375,78.87109375,57.91590893695515
JPG QF = 10 b/w,10,1,True,False,True,True,True,187.59375,64.5908203125,65.56877811094452
JPG QF = 10,10,1,True,False,False,True,True,146.6474609375,52.4365234375,64.24314263453354
JPG QF = 10 b/w,10,1,True,False,True,True,True,146.6806640625,41.1015625,71.97888163194652
JPG QF = 10,10,1,True,False,False,True,True,163.20703125,60.1640625,63.136353845049186
JPG QF = 10 b/w,10,1,True,False,True,True,True,163.2451171875,47.7041015625,70.77762423502809
